# 节点搭建

## 搭建挖矿节点
### 矿机系统安装
* 推荐使用超脑定制的ubuntu的iso镜像包安装

* 自行安装保证系统版本为ubuntu(18.0)版本,同时需要安装node.js(v8.10.0)和pm2（使用npm安装），和logrotate程序(日志清理apt-get install logrotate)


### 安装程序(miner_setup.tar)下载

**---------注意: 不同交易所请下载对应的程序包---------**

* MXC交易所
    * 下载地址：http://40.73.35.128:7656/download/exchange/mxc/miner_setup.tar
    * md5sum： 6a462df60e2aa1f84794bbf272006763
    

### 矿机程序安装运行
* 拷贝矿机程序 miner_setup.tar 到用户自己根目录(~/)下并解压
```text
cd ~/
tar -xvf miner_setup.tar
```
* 执行安装文件 install.sh
```text
chmod +x ~/miner_setup/install.sh
~/miner_setup/install.sh
```
* 完成启动，检查是否正常启动 

```text
通过tail命令查看是否有正常返回结构

curl 127.0.0.1:8888/v1/chain/get_chain_info

通过tail命令查看日志是否输入是否有异常

tail -f ~/log/seed.log
```

## 搭建mongo节点

### 矿机系统安装

* 推荐使用超脑定制的ubuntu的iso镜像包安装

* 自行安装保证系统版本为ubuntu(18.0)版本,同时需要安装node.js(v8.10.0)和pm2（使用npm安装）

### mongo相关安装和启动

#### 下载mongo程序安装包（mongo.tar ）

* 下载地址

   http://40.73.35.128:7656/download/mongo/mongo.tar

* md5sum

    417462734732788e7a1e3e291822017e

#### mongo程序安装

* 拷贝mongo安装程序 mongo.tar 到用户自己根目录(~/)并解压
```text
cd ~/
tar -xvf mongo.tar
```

* 安装mongo相关依赖包
```text
apt install libcurl3 libcurl-openssl1.0-dev
```
* mongo配置并启动
```text
删除历史数据
rm -rf ~/mongodb/data && rm -rf ~/mongodb/log

创建mongo数据和log目录
mkdir -p ~/mongodb/data && mkdir -p ~/mongodb/log

启动mongo
~/mongodb/bin/mongod --dbpath ~/mongodb/data --logpath ~/mongodb/log/mongodb.log --fork --bind_ip 0.0.0.0

登陆（mongoshell）
~/mongodb/bin/mongo

切换数据库
use ultrain

创建账户
db.createUser( {user: "root", pwd: "ultrain",roles: [ { role: "readWriteAnyDatabase", db: "admin" }]})

退出mongo
exit

关闭数据库
killall mongod

授权方式启动
~/mongodb/bin/mongod --auth --dbpath ~/mongodb/data --logpath ~/mongodb/log/mongodb.log --fork --bind_ip 0.0.0.0
```

### 矿机程序安装运行

### 安装程序(mongo_setup.tar)下载

**---------注意: 不同交易所请下载对应的程序包---------**

* MXC交易所
    * 下载地址：http://40.73.35.128:7656/download/exchange/mxc/mongo_setup.tar
    * md5sum： 96a2c80adadb7f5348f184ff4bd5e425


### 矿机程序安装运行

* 拷贝矿机程序(mongo_setup.tar)到用户自己根目录(~/)并解压
```text
cd ~/
tar -xvf mongo_setup.tar
```
* 执行安装文件install.sh
```text
chmod +x ~/mongo_setup/install.sh
~/mongo_setup/install.sh
```

* 完成启动，检查是否正常启动 

```text
通过tail命令查看是否有正常返回结构

curl 127.0.0.1:8888/v1/chain/get_chain_info

通过tail命令查看日志是否输入是否有异常

tail -f ~/log/mongo.log
```

## 矿机运维

### 重启矿机

* 先关闭nod进程
```text
killall nodultrain
```

* 使用启动脚本启动nod程序
```text
~/runultrain-h.sh
```

### 管家相关

* 启动管家

```text
pm2 start /root/ultrainmng/src/sideChainService.js
```

* 重启管家
```text
pm2 restart sideChainService
```

* 关闭管家
```test
pm2 stop sideChainService
```

### 数据drity手动处理方式

#### 现象

如果nod节点没有正常退出，如使用（kill -9)结束或者机器意外宕机，会造成本地数据dirty，无法启动，如下图所示：
    
![dirty.jpg](https://note.youdao.com/src/WEBRESOURCEf6f3fb6fefb31daa60175ab562a7f8c0)

#### 处理方式

* 1- 删除本地state目录下的文件

```text
rm ~/.local/share/ultrainio/nodultrain/data/state/* -rf
```

* 2- mongo节点清除mongo本地所有数据（如果是seed节点不需要）

* 3- 通过世界状态文件进行重启nod文件（如果是mongo节点，此时会将本地块数据重新写到mongo中并保证mongo数据没有重复和遗漏！！！）

```text
先找到 mongo_setup 或 miner_setup中/files/ws/目录下的ws文件，然后通过如下命令启动即可：

nohup ~/nodultrain --worldstate ~/mongo_setup/files/ws/99b1cef2acdf6c4bcbce64c6490a999b819c236b19e3cd7cd2c3accc71da30ef-655000.ws &>> ~/log/mongo.log &
```

    
    
    



